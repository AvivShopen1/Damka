<html>
<head>
        <title></title>
        <meta charset="UTF-8">
        <style>
            .chess-board { border-spacing: 0; border-collapse: collapse; }
            .chess-board th { padding: .5em; }
            .chess-board td { border: 1px solid; width: 4em; height: 4em; }
            .chess-board .light { background: #E2CC97; }
            .chess-board .dark { background: #8D4C4C; }
			.center {
				display: block;
				margin-left: auto;
				margin-right: auto
			}
        </style>
    </head>
    <body>
	<center id="center">
		<div id="startMenu" style="position:absolute;width:100%;height:100%;background:#FFFFFFCC">
		<b><a style="font-size:100;position: absolute;margin-top: 40px;margin-left: auto;margin-right: auto;left: 0;right: 0;">דמקה</a></b>
		<button onclick="connect();" style="outline:none;position:absolute; margin-top:250px; width:250px; height:100px; margin-left: auto; margin-right: auto; left: 0; right: 0; background: #27BF2C; color: white; font-size:50;"><b>!שחק</b></button>
		
		</div>
	
        <table class="chess-board">
            <tbody>
                <tr>
                    <th></th>
                    <th>a</th>
                    <th>b</th>
                    <th>c</th>
                    <th>d</th>
                    <th>e</th>
                    <th>f</th>
                    <th>g</th>
                    <th>h</th>
                </tr>
                <tr>
                    <th>8</th>
                    <td class="light" ondrop="onDrop" id="a8"></td>
                    <td class="dark" id="b8"></td>
                    <td class="light" id="c8"></td>
                    <td class="dark" id="d8"></td>
                    <td class="light" id="e8"></td>
                    <td class="dark" id="f8"></td>
                    <td class="light" id="g8"></td>
                    <td class="dark" id="h8"></td>
                </tr>
                <tr>
                    <th>7</th>
                    <td class="dark" id="a7"></td>
                    <td class="light" id="b7"></td>
                    <td class="dark" id="c7"></td>
                    <td class="light" id="d7"></td>
                    <td class="dark" id="e7"></td>
                    <td class="light" id="f7"></td>
                    <td class="dark" id="g7"></td>
                    <td class="light" id="h7"></td>
                </tr>
                <tr>
                    <th>6</th>
                    <td class="light" id="a6"></td>
                    <td class="dark" id="b6"></td>
                    <td class="light" id="c6"></td>
                    <td class="dark" id="d6"></td>
                    <td class="light" id="e6"></td>
                    <td class="dark" id="f6"></td>
                    <td class="light" id="g6"></td>
                    <td class="dark" id="h6"></td>
                </tr>
                <tr>
                    <th>5</th>
                    <td class="dark" id="a5"></td>
                    <td class="light" id="b5"></td>
                    <td class="dark" id="c5"></td>
                    <td class="light" id="d5"></td>
                    <td class="dark" id="e5"></td>
                    <td class="light" id="f5"></td>
                    <td class="dark" id="g5"></td>
                    <td class="light" id="h5"></td>
                </tr>
                <tr>
                    <th>4</th>
                    <td class="light" id="a4"></td>
                    <td class="dark" id="b4"></td>
                    <td class="light" id="c4"></td>
                    <td class="dark" id="d4"></td>
                    <td class="light" id="e4"></td>
                    <td class="dark" id="f4"></td>
                    <td class="light" id="g4"></td>
                    <td class="dark" id="h4"></td>
                </tr>
                <tr>
                    <th>3</th>
                    <td class="dark" id="a3"></td>
                    <td class="light" id="b3"></td>
                    <td class="dark" id="c3"></td>
                    <td class="light" id="d3"></td>
                    <td class="dark" id="e3"></td>
                    <td class="light" id="f3"></td>
                    <td class="dark" id="g3"></td>
                    <td class="light" id="h3"></td>
                </tr>
                <tr>
                    <th>2</th>
                    <td class="light" id="a2"></td>
                    <td class="dark" id="b2"></td>
                    <td class="light" id="c2"></td>
                    <td class="dark" id="d2"></td>
                    <td class="light" id="e2"></td>
                    <td class="dark" id="f2"></td>
                    <td class="light" id="g2"></td>
                    <td class="dark" id="h2"></td>
                </tr>
                <tr>
                    <th>1</th>
                    <td class="dark" id="a1"></td>
                    <td class="light" id="b1"></td>
                    <td class="dark" id="c1"></td>
                    <td class="light" id="d1"></td>
                    <td class="dark" id="e1"></td>
                    <td class="light" id="f1"></td>
                    <td class="dark" id="g1"></td>
                    <td class="light" id="h1"></td>
                </tr>
            </tbody>
        </table>
		</center>
		<h1 style="position:absolute;right: 10%;margin-top:auto;margin-bottom:auto;top: 50%;bottom:0;">00:00</h1>
		<script>
		var server, color = null, board = {}, possible_moves = {}, current_move = null;
		
		function create_solider(a, b, solider_color = false, king = false)
		{
			var center = document.createElement("center"), img = document.createElement("img");
			center.style.position = "relative";
			img.src = (solider_color ? "white.png" : "black.png");
			img.id="img-" + a + b;
			img.style.width = "50px";
			img.style.height = "50px";
			img.draggable = true;
			center.appendChild(img);
			
			if(king)
			{
				let img = document.createElement("img");
				img.src = "crown.png";
				img.id = "crown-" + a + b;
				img.style.position = "absolute";
				img.style.right = "7px";
				img.style.width = "50px";
				img.style.height = "50px";
				img.draggable = true;
				center.appendChild(img);
			}
		
			center.addEventListener("mousedown", () => {
				if(solider_color === color)
					create_possible_moves(a, b);
			});
			board[a + b] = {color: solider_color, king: king};
			document.getElementById(a + b).appendChild(center);
		}
		
		function create_possible_move(a, b, color = false, canEat = false)
		{
			if(a.charCodeAt(0) < 97 || a.charCodeAt(0) > 104)
				return false;
				
			if(b < 1 || b > 8)
				return false;
				
			if(typeof(board[a + b]) !== "undefined")
			{
				if(!canEatSolider(current_move, a + b))
					return false;
					
				let num1 = a.charCodeAt(0) - current_move[0].charCodeAt(0), num2 = parseInt(b) - parseInt(current_move[1]);
				create_possible_move(addChar(a, num1), parseInt(b) + num2, color, a + b);
				return false;
			}
				
			var center = document.createElement("center"), img = document.createElement("img");
			img.src = (color ? "possible_move_white.png" : "possible_move_black.png");
			img.id="img-" + a + b;
			img.style.width = "50px";
			img.style.height = "50px";
			img.draggable = true;
			img.addEventListener("click", () => {
				console.log(a + b);
			});
			img.addEventListener("dragover", () => {
				event.preventDefault();
			});
			img.addEventListener("drop", (event) => {
				if(current_move === null)
					return;
					
				if(canEat !== false)
					server.send("eat;" + canEat);
				server.send("move;" + current_move + ";" + a + b);
			});
			center.appendChild(img);
			let square = document.getElementById(a + b);
			possible_moves[a + b] = {color: color, square: square};
			square.appendChild(center);
			return true;
		}
		
		function remove_possible_move(a, b)
		{
			if(typeof(possible_moves[a + b]) === "undefined")
				return;
				
			document.getElementById(a + b).innerHTML = '';
		}
		
		function clear_board()
		{
			for(var i in board)
			{
				document.getElementById(i).innerHTML = '';
				delete board[i];
			}
		}
		
		function exists(a, b)
		{
			return typeof(board[a + b]) !== "undefined";
		}
		
		function create_possible_moves(a, b)
		{
			if(typeof(board[a + b]) === "undefined")
				return;
				
			for(var i in possible_moves)
			{
				possible_moves[i].square.innerHTML = '';
				delete possible_moves[i];
			}
		
			current_move = a + b;
			let solider = board[a + b];
			if(solider.king)
			{
				var i;
				let y = parseInt(b);
				
				for(i = y + 1; i < 9; i++)
				{
					if(!create_possible_move(addChar(a, i - y), i, solider.color))
						break;
				}
				
				for(i = y + 1; i < 9; i++)
				{
					if(!create_possible_move(addChar(a, -(i - y)), i, solider.color))
						break;
				}
				
				for(i = y - 1; i > 0; i--)
				{
					if(!create_possible_move(addChar(a, y - i), i, solider.color))
						break;
				}
				
				for(i = y - 1; i > 0; i--)
				{
					if(!create_possible_move(addChar(a, -(y - i)), i, solider.color))
						break;
				}
			}else
			{
				// White
				if(solider.color)
				{
					let y = parseInt(b) + 1;
					var x = addChar(a, 1);
					if(typeof(board[x + y]) === "undefined")
					{
						create_possible_move(x, y, true);
					}else if(board[x + y].color !== solider.color)
					{
						create_possible_move(addChar(x, 1), y + 1, true, x + y);
					}
					
					x = addChar(a, -1);
					if(typeof(board[x + y]) === "undefined")
					{
						create_possible_move(x, y, true);
					}else if(board[x + y].color !== solider.color)
					{
						create_possible_move(addChar(x, -1), y + 1, true, x + y);
					}
				}else
				{
					let y = parseInt(b) - 1;
					var x = addChar(a, 1);
					if(typeof(board[x + y]) === "undefined")
					{
						create_possible_move(x, y, false);
					}else if(board[x + y].color !== solider.color)
					{
						create_possible_move(addChar(x, 1), y - 1, false, x + y);
					}
					
					x = addChar(a, -1);
					if(typeof(board[x + y]) === "undefined")
					{
						create_possible_move(x, y, false);
					}else if(board[x + y].color !== solider.color)
					{
						create_possible_move(addChar(x, -1), y - 1, false, x + y);
					}
				}
			}
		}
		
		function canEatSolider(ab, ab2)
		{
			if(typeof(board[ab2]) === "undefined" || typeof(board[ab]) === "undefined")
				return false;
				
			let a1 = ab[0], a2 = ab2[0], b1 = parseInt(ab[1]), b2 = parseInt(ab2[1]);
			return board[ab2].color !== board[ab].color && Math.abs(a1.charCodeAt(0) - a2.charCodeAt(0)) == 1 && Math.abs(b1 - b2) == 1;
		}
		
		function addChar(charac, add)
		{
			if(charac === null || charac.length !== 1)
				return null;
				
			return String.fromCharCode(charac.charCodeAt(0) + add);
		}
		
		function remove_solider(a, b)
		{
			document.getElementById(a + b).innerHTML = '';
			if(typeof(board[a + b]) !== "undefined")
				delete board[a + b];
		}
			
		function drag(ev) {
		  ev.dataTransfer.setData("text", ev.target.id);
		}

		function move_solider(a1, b1, a2, b2)
		{
			let solider = board[a1 + b1];
			remove_solider(a1, b1);
			create_solider(a2, b2, solider.color, solider.king);
		}
		
		function connect()
		{
			server = new WebSocket("ws://localhost:8080", "echo-protocol");
			
			// Connection opened
			server.addEventListener('open', function (event) {
			});
			// Connection opened
			server.addEventListener('message', function (message) {
				var args = message.data.split(";");
				if(args[0] === "start")
				{
					color = (args[1] === "white");
					start();
				}else if(args[0] === "move")
				{
					for(var i in possible_moves)
					{
						possible_moves[i].square.innerHTML = '';
						delete possible_moves[i];
					}
					move_solider(args[1][0], args[1][1], args[2][0], args[2][1]);
				}else if(args[0] === "eat")
				{
					remove_solider(args[1][0], args[1][1]);
				}else if(args[0] === "king")
				{
					let solider = board[args[1]];
					if(typeof(solider) === "undefined")
						return;
						
					remove_solider(args[1][0], args[1][1]);
					create_solider(args[1][0], args[1][1], solider.color, true);
				}
			});	
			
		}
		
		function start()
		{
			document.getElementById("center").removeChild(document.getElementById("startMenu"));
		
			// Black
			create_solider("b", "8", false);
			create_solider("d", "8", false);
			create_solider("f", "8", false);
			create_solider("h", "8", false);
			create_solider("a", "7", false);
			create_solider("c", "7", false);
			create_solider("e", "7", false);
			create_solider("g", "7", false);
			create_solider("b", "6", false);
			create_solider("d", "6", false);
			create_solider("f", "6", false);
			create_solider("h", "6", false);
			
			// White
			create_solider("a", "1", true);
			create_solider("c", "1", true);
			create_solider("e", "1", true);
			create_solider("g", "1", true);
			create_solider("b", "2", true);
			create_solider("d", "2", true);
			create_solider("f", "2", true);
			create_solider("h", "2", true);
			create_solider("a", "3", true);
			create_solider("c", "3", true);
			create_solider("e", "3", true);
			create_solider("g", "3", true);
		}
		</script>
    </body>
</html>
